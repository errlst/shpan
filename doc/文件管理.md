> 后文中使用"条目"表示文件和目录。

系统中存在两种文件：

- 用户空间文件。(只表示文件路径等信息，不包含具体文件内容，存在数据库中)。
- 数据文件(存放实际数据的文件，存在文件系统中)，存放在目录`hash_filesize`下(`hash`为文件的哈希值，`filesize`为文件尺寸)，命名为`当前目录文件数量+1`。

###### 重复数据删除

具有相同数据的文件，只在服务器上保存一份实际数据。

临时文件上传成功后，服务器查找`$(hash)_$(filesize)`目录下是否存在文件：

- 如果存在，创建其中所有文件的`fileblob`对象集合。并依次比较该集合中的`fileblob`各个块的 hash 和临时文件各个块的 hash 是否相等，并将不相等的`fileblob`移出集合。

  - 如果最后集合为空，则将临时文件移动到该目录，并命名为`当前目录文件数量+1`(使用 0 填充 8 字符)。
  - 否则，最后集合中应该只存在一个`fileblob`，即可以进行重复数据删除。

- 如果不存在，则创建目录，并将临时文件移入该目录，并命名为`00000000`。

###### 条目表

| 字段         | 类型 | 描述             |
| ------------ | ---- | ---------------- |
| id           | int  | 主键，自增       |
| is_directory | bool | 是目录还是文件   |
| path         | text | 用户空间完整路径 |
| ref_id       | int  | 引用表的 id      |
| shared_link  | text | 共享链接         |

###### 条目关系表

c

###### 文件引用表

文件引用表是用户空间文件和具体数据文件之间的关系。

| 字段      | 类型 | 描述                                    |
| --------- | ---- | --------------------------------------- |
| id        | int  | 主键，自增                              |
| path      | text | 数据文件路径                            |
| ref_count | int  | 引用的数量，减少为 0 时，会删除数据文件 |

###### 共享链接表

用户空间的每个条目只能有一个共享链接，共享链接名称为 `${email}${path}`。

| 字段     | 类型 | 描述     |
| -------- | ---- | -------- |
| link     | text | 共享链接 |
| entry_id | int  | 条目 id  |

###### 文件操作

以下操作针对用户空间文件。

###### 文件查找

客户端请求

```json
{
  "req": "search_entry",
  "data": {
    "path": ""
  }
}
```

服务端正常响应

```json
{
  "resp": "search_entry",
  "data": {
    "path": "",
    "type": "", // f 或者 d
    "name": "",
    "shared_link": "", // null 或 链接
    "state": true,
    "msg": "",
    // 如果是文件类型，包含以下数据
    "size": 0,
    // 如果是目录，包含以下数据
    "children": [] // 目录下的所有条目
  }
}
```

###### 删除文件

删除文件实际上只删除对应的条目表和文件引用表中的引用计数。

客户端请求

```json
{
  "req": "del_entry",
  "data": {
    "path": ""
  }
}
```

服务端响应

```json
{
  "resp": "del_entry",
  "data": {
    "path": "",
    "state": true,
    "msg": ""
  }
}
```

###### 移动文件

移动文件只需要修改条目关系表，如果目的目录不存在，需要由客户端请求创建目录。如果该目录中已存在条目，则返回失败。

客户端请求

```json
{
  "req": "move_entry",
  "data": {
    "path": "",
    "new_path": ""
  }
}
```

服务端响应

```json
{
  "resp": "move_entry",
  "data": {
    "path": "",
    "new_path": "",
    "state": true,
    "msg": ""
  }
}
```

###### 创建目录

客户端请求

```json
{
  "req": "mk_directory",
  "data": {
    "path": ""
  }
}
```

服务端响应

```json
{
  "resp": "mk_directory",
  "data": {
    "path": "",
    "state": true,
    "msg": ""
  }
}
```
