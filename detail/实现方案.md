## 用户空间管理

网盘设计的关键是元数据与文件内容的分离存储与管理。所谓文件元数据就是文件属性、访问控制这些文件的基础信息，事实上，传统文件系统也是元数据与文件内容分离管理的，比如 Linux 的文件元数据记录在文件控制块 FCB 中，Windows 的文件元数据记录在文件分配表 FAB 中。

#### 方案一

直接使用 linux 文件系统作为用户空间，对于每一个用户，其 email 唯一，因此可为每一个用户创建一个 `${email}` 目录，并在其中创建目录和文件。

为了实现重复数据删除，需要对数据文件创建链接，链接到具体的数据文件上。

- 如果使用软链接，则需要额外维护数据文件的软链接数量，才能实现无效数据删除。
- 使用硬链接需要源文件和链接文件处于同一文件系统上，涉及 RAID 或其他复杂的文件系统整合。

#### 方案二

使用数据库维护用户空间，数据文件直接存放在文件系统中，数据库中存放对应的路径。

#### 总结

因此，本系统选择方案二。将元信息存储在数据库中，文件内容则直接以系统文件的形式存储，而不做其他处理。

## 重复数据删除

网盘保存的很多文件，内容其实是重复的，比如电影、电子书等等。一方面，重复上传这些文件会加大网盘的存储负载压力；另一方面，每次都要重新上传重复的内容，会导致用户网络带宽的浪费和用户等待时间过长的问题。所以，在设计中，物理上相同的文件，系统只会保存一份。

#### 方案一

上传文件前客户端先计算一次文件的哈希值，再根据哈希值判断文件是否存在，如果文件已经存在，则只需要建立对数据文件的链接即可，而无需用户上传真正的文件。

但是，只使用哈希值很容易产生哈希碰撞，所以系统还需要更多信息判断两个文件是否相同，且网盘系统对实时性要求不高，相较于哈希函数的效率，更多需要考虑哈希函数的安全性。

使用该方案可以实现秒传，但需要承担哈希冲突的风险。

#### 方案二

一定能保证两个文件一定相同的方式就是直接判断两个文件内容是否相等。

因此可以选择将具有相同哈希值的文件存放在同一个目录下，当用户上传文件之后，在该目录中查找是否存在文件，并续判断文件内容是否相同。如果完全相同，则只需创建一份文件链接，而无需存放数据文件。

使用该方案无法实现秒传，但没有哈希冲突的风险。

#### 总结

因此，本系统选择方案一，且采用 sha3-512 + filesize 的方式验证文件的唯一性，将系统风险降低到足够低。

## 参考

[网盘系统实现分析](https://time.geekbang.org/column/article/489820)

[国内主流网盘实现分析](https://yangyuan.github.io/post/2014-04-12-zh-china-cloud-drives/)
